<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A minimalistic task manager for today and tomorrow">
    <meta name="theme-color" content="#f6fafe" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f1417" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="It Can Wait">
    <link rel="manifest" href="/it-can-wait/manifest.json">
    <title>It Can Wait</title>
    <style>
        :root {
            --md-sys-color-primary: #006491;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #c7e7ff;
            --md-sys-color-on-primary-container: #001e2e;
            --md-sys-color-surface: #f6fafe;
            --md-sys-color-surface-container: #eaeef3;
            --md-sys-color-surface-container-high: #e4e9ee;
            --md-sys-color-surface-container-highest: #dee3e8;
            --md-sys-color-on-surface: #171c1f;
            --md-sys-color-on-surface-variant: #41484d;
            --md-sys-color-outline: #71787e;
            --md-sys-color-outline-variant: #c0c7cd;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-error-container: #ffdad6;
            --complete-color: #1a6e37;
            --shadow-1: 0 1px 2px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #80cfff;
            --md-sys-color-on-primary: #00344d;
            --md-sys-color-primary-container: #004c6e;
            --md-sys-color-on-primary-container: #c7e7ff;
            --md-sys-color-surface: #0f1417;
            --md-sys-color-surface-container: #1b2024;
            --md-sys-color-surface-container-high: #252b2f;
            --md-sys-color-surface-container-highest: #30363a;
            --md-sys-color-on-surface: #dee3e8;
            --md-sys-color-on-surface-variant: #c0c7cd;
            --md-sys-color-outline: #8a9297;
            --md-sys-color-outline-variant: #41484d;
            --md-sys-color-error: #ffb4ab;
            --md-sys-color-error-container: #93000a;
            --complete-color: #7dd99b;
            --shadow-1: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Google Sans', 'Roboto', system-ui, sans-serif;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            display: flex;
            height: 100vh;
            background: var(--md-sys-color-outline-variant);
            position: relative;
        }

        /* â”€â”€ Divider â”€â”€ */
        .divider {
            background: var(--md-sys-color-surface-container);
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: stretch;
            flex-shrink: 0;
            position: relative;
            overflow: visible;
        }

        .divider-text {
            font-family: 'Courier New', Courier, monospace;
            font-size: 10px;
            color: var(--md-sys-color-outline);
            white-space: nowrap;
            letter-spacing: 0.4em;
            position: absolute;
        }

        /* â”€â”€ Panel â”€â”€ */
        .panel {
            flex: 1;
            background: var(--md-sys-color-surface);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        /* â”€â”€ Header â”€â”€ */
        .header {
            padding: 20px 20px 14px 20px;
            background: var(--md-sys-color-surface-container);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            text-align: center;
            letter-spacing: -0.01em;
            text-transform: lowercase;
        }

        .header .date {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            text-align: center;
            margin-top: 2px;
        }

        .progress-bar {
            margin-top: 12px;
            height: 3px;
            background: var(--md-sys-color-outline-variant);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--complete-color);
            transition: width 0.4s cubic-bezier(0.4,0,0.2,1);
            border-radius: 2px;
        }

        .progress-text {
            font-size: 11px;
            color: var(--md-sys-color-outline);
            margin-top: 5px;
            text-align: center;
            letter-spacing: 0.02em;
        }

        /* â”€â”€ Add entry â”€â”€ */
        .add-entry {
            padding: 12px 16px;
            background: var(--md-sys-color-surface);
        }

        .add-entry form {
            margin: 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .add-entry input {
            flex: 1;
            padding: 14px 16px;
            background: var(--md-sys-color-surface-container-highest);
            border: none;
            border-radius: 28px;
            color: var(--md-sys-color-on-surface);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: background 0.2s;
        }

        .add-entry input:focus {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .add-entry input::placeholder { color: var(--md-sys-color-outline); }

        .add-btn {
            padding: 14px 22px;
            background: var(--md-sys-color-primary);
            border: none;
            border-radius: 28px;
            color: var(--md-sys-color-on-primary);
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            font-weight: 500;
            box-shadow: var(--shadow-1);
            transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
        }

        .add-btn:active { transform: scale(0.96); box-shadow: none; }

        /* â”€â”€ Entries â”€â”€ */
        .entries {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px 80px;
        }

        .entries::-webkit-scrollbar { width: 0; }

        .entry {
            background: var(--md-sys-color-surface-container);
            border: none;
            border-radius: 16px;
            padding: 14px 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-1);
            transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
        }

        .entry:active { box-shadow: none; transform: scale(0.99); }
        .entry.completed { opacity: 0.55; }
        .entry.completed .entry-text { text-decoration: line-through; color: var(--md-sys-color-outline); }
        .entry.dragging { opacity: 0.4; box-shadow: none; }

        .drag-handle {
            width: 18px; min-width: 18px; height: 20px;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; gap: 3px; cursor: grab; opacity: 0.35;
        }

        .drag-handle:active { cursor: grabbing; opacity: 0.7; }

        .drag-handle span {
            width: 14px; height: 2px;
            background: var(--md-sys-color-on-surface-variant);
            border-radius: 1px;
        }

        .checkbox {
            width: 22px; height: 22px; min-width: 22px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
        }

        .checkbox:active { transform: scale(0.9); }
        .checkbox.checked { background: var(--complete-color); border-color: var(--complete-color); }
        .checkbox.checked::after { content: 'âœ“'; color: white; font-size: 13px; font-weight: bold; }

        .entry-text {
            flex: 1; font-size: 14px; word-break: break-word;
            color: var(--md-sys-color-on-surface); line-height: 1.4;
        }

        .timestamp {
            font-size: 11px; color: var(--md-sys-color-outline);
            margin-top: 3px; letter-spacing: 0.01em;
        }

        .entry-actions { display: flex; gap: 6px; }

        .btn {
            padding: 7px 12px;
            background: var(--md-sys-color-surface-container-high);
            border: none; border-radius: 20px;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer; font-size: 16px;
            transition: all 0.2s; line-height: 1;
        }

        .btn:active {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            transform: scale(0.94);
        }

        .btn.danger:active {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-error);
        }

        /* â”€â”€ FAB â”€â”€ */
        .fab {
            position: fixed;
            bottom: 28px;
            right: 28px;
            z-index: 100;
        }

        .fab-main {
            width: 64px; height: 64px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none; border-radius: 20px;
            font-size: 28px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        .fab-main:active { transform: scale(0.94); box-shadow: none; }
        .fab-main.open { border-radius: 16px; }

        .fab-speed-dial {
            position: absolute;
            bottom: 76px; right: 0;
            display: flex; flex-direction: column;
            align-items: flex-end; gap: 10px;
            opacity: 0; pointer-events: none;
            transform: translateY(20px);
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
        }

        .fab-speed-dial.open {
            opacity: 1; pointer-events: all;
            transform: translateY(0);
        }

        .fab-item {
            display: flex; align-items: center; gap: 10px;
        }

        .fab-item-label {
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            padding: 6px 12px; border-radius: 8px;
            font-size: 13px; font-weight: 500;
            box-shadow: var(--shadow-1);
            white-space: nowrap;
        }

        .fab-mini {
            width: 48px; height: 48px;
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            border: none; border-radius: 14px;
            font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-1);
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .fab-mini:active {
            background: var(--md-sys-color-primary-container);
            transform: scale(0.94);
        }

        /* Color swatch fab minis */
        .fab-mini.color-swatch-fab {
            overflow: hidden; position: relative;
        }

        .fab-mini.color-swatch-fab input[type="color"] {
            opacity: 0; position: absolute;
            width: 100%; height: 100%;
            cursor: pointer; border: none; padding: 0;
        }

        /* â”€â”€ Bottom sheets â”€â”€ */
        .sheet-overlay {
            display: none; position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 200;
            align-items: flex-end; justify-content: center;
        }

        .sheet-overlay.active { display: flex; }

        .sheet {
            background: var(--md-sys-color-surface-container);
            border-radius: 28px 28px 0 0;
            width: 100%; max-width: 700px; max-height: 85vh;
            display: flex; flex-direction: column;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            animation: slideUp 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .sheet-handle {
            width: 32px; height: 4px;
            background: var(--md-sys-color-outline-variant);
            border-radius: 2px; margin: 12px auto 0;
        }

        .sheet-header {
            padding: 16px 24px 12px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .sheet-header h2 {
            font-size: 18px; font-weight: 500;
            color: var(--md-sys-color-on-surface);
            text-transform: lowercase;
        }

        .sheet-close {
            background: var(--md-sys-color-surface-container-highest);
            border: none; border-radius: 20px;
            padding: 7px 14px; cursor: pointer;
            font-size: 13px; font-family: inherit; font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.2s;
        }

        .sheet-close:active {
            background: var(--md-sys-color-error-container);
            color: var(--md-sys-color-error);
        }

        .sheet-body {
            flex: 1; overflow-y: auto;
            padding: 8px 16px 32px;
        }

        .sheet-action {
            display: flex; align-items: center; gap: 16px;
            background: var(--md-sys-color-surface-container-highest);
            border: none; border-radius: 16px;
            padding: 16px; cursor: pointer;
            text-align: left; width: 100%;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .sheet-action:active {
            background: var(--md-sys-color-primary-container);
            transform: scale(0.98);
        }

        .sheet-action-icon { font-size: 22px; width: 32px; text-align: center; flex-shrink: 0; }
        .sheet-action-label { font-size: 15px; font-weight: 500; color: var(--md-sys-color-on-surface); font-family: inherit; }
        .sheet-action-sub { font-size: 12px; color: var(--md-sys-color-outline); margin-top: 2px; font-family: inherit; }

        .archive-entry-tag {
            font-size: 10px; color: var(--md-sys-color-outline);
            text-transform: uppercase; letter-spacing: 0.08em;
            margin-top: 2px;
        }

        /* â”€â”€ Media queries â”€â”€ */
        @media (max-width: 600px) {
            .container { flex-direction: column; }
            .divider { width: 100%; min-height: 24px; }
            .divider-text { left: 50%; top: 50%; transform: translate(-50%, -50%); }
            .fab { bottom: 20px; right: 20px; }
        }

        @media (min-width: 601px) {
            .container { flex-direction: row; }
            .divider { width: 24px; min-width: 24px; height: 100%; }
            .divider-text { left: 50%; top: 50%; transform: translate(-50%, -50%) rotate(-90deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Today Panel -->
        <div class="panel">
            <div class="header">
                <h1>today</h1>
                <div class="date" id="today-date"></div>
                <div class="progress-bar"><div class="progress-fill" id="today-progress" style="width:0%"></div></div>
                <div class="progress-text" id="today-progress-text">0 of 0 completed</div>
            </div>
            <div class="add-entry">
                <form id="today-form">
                    <input type="text" id="today-input" placeholder="Add a task..." autocomplete="off">
                    <button type="submit" class="add-btn">add</button>
                </form>
            </div>
            <div class="entries" id="today-entries"></div>
        </div>

        <!-- Divider -->
        <div class="divider"><div class="divider-text">it can wait</div></div>

        <!-- Tomorrow Panel -->
        <div class="panel">
            <div class="header">
                <h1>tomorrow</h1>
                <div class="date" id="tomorrow-date"></div>
                <div class="progress-bar"><div class="progress-fill" id="tomorrow-progress" style="width:0%"></div></div>
                <div class="progress-text" id="tomorrow-progress-text">0 of 0 completed</div>
            </div>
            <div class="add-entry">
                <form id="tomorrow-form">
                    <input type="text" id="tomorrow-input" placeholder="Add a task..." autocomplete="off">
                    <button type="submit" class="add-btn">add</button>
                </form>
            </div>
            <div class="entries" id="tomorrow-entries"></div>
        </div>
    </div>

    <!-- FAB Speed Dial -->
    <div class="fab" id="fab">
        <div class="fab-speed-dial" id="fab-speed-dial">

            <!-- Theme toggle -->
            <div class="fab-item">
                <div class="fab-item-label">light / dark</div>
                <button class="fab-mini" id="theme-toggle">ðŸŒ™</button>
            </div>

            <!-- Primary color -->
            <div class="fab-item">
                <div class="fab-item-label">primary color</div>
                <button class="fab-mini color-swatch-fab" id="primary-swatch" style="background:#006491;">
                    <input type="color" id="primary-color-picker" value="#006491">
                </button>
            </div>

            <!-- Surface color -->
            <div class="fab-item">
                <div class="fab-item-label">surface color</div>
                <button class="fab-mini color-swatch-fab" id="surface-swatch" style="background:#eaeef3;">
                    <input type="color" id="surface-color-picker" value="#eaeef3">
                </button>
            </div>

            <!-- Clear completed -->
            <div class="fab-item">
                <div class="fab-item-label">clear completed</div>
                <button class="fab-mini" id="fab-clear">âœ“</button>
            </div>

            <!-- Archive -->
            <div class="fab-item">
                <div class="fab-item-label">archive</div>
                <button class="fab-mini" id="fab-archive">ðŸ“¦</button>
            </div>

        </div>
        <button class="fab-main" id="fab-main">ï¼‹</button>
    </div>

    <!-- Archive Sheet -->
    <div class="sheet-overlay" id="archive-sheet">
        <div class="sheet">
            <div class="sheet-handle"></div>
            <div class="sheet-header">
                <h2>archive</h2>
                <button class="sheet-close" id="close-archive">close</button>
            </div>
            <div class="sheet-body" id="archive-entries"></div>
        </div>
    </div>

    <!-- FAB backdrop -->
    <div id="fab-backdrop" style="display:none;position:fixed;inset:0;z-index:99;" ></div>

    <script>
        let data = {
            today: [],
            tomorrow: [],
            archived: []   // single unified archive, entries have a .day tag
        };

        function loadData() {
            const saved = localStorage.getItem('fold-notes-data');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    data.today = parsed.today || [];
                    data.tomorrow = parsed.tomorrow || [];
                    // Migrate old split archive to unified
                    if (Array.isArray(parsed.archived)) {
                        data.archived = parsed.archived;
                    } else if (parsed.archived) {
                        const t = (parsed.archived.today || []).map(e => ({...e, day:'today'}));
                        const m = (parsed.archived.tomorrow || []).map(e => ({...e, day:'tomorrow'}));
                        data.archived = [...t, ...m];
                    }
                } catch(e) {
                    data = { today:[], tomorrow:[], archived:[] };
                }
            }
        }

        function saveData() {
            localStorage.setItem('fold-notes-data', JSON.stringify(data));
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        }

        function formatTimestamp(ts) {
            if (!ts) return '';
            const diff = Date.now() - ts;
            const m = Math.floor(diff/60000);
            const h = Math.floor(diff/3600000);
            const d = Math.floor(diff/86400000);
            if (m < 1) return 'just now';
            if (m < 60) return `${m}m ago`;
            if (h < 24) return `${h}h ago`;
            if (d < 7) return `${d}d ago`;
            return new Date(ts).toLocaleDateString('en-US', { month:'short', day:'numeric' });
        }

        function updateDates() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('today-date').textContent = formatDate(today);
            document.getElementById('tomorrow-date').textContent = formatDate(tomorrow);
        }

        function createEntryElement(entry, day, isArchived=false) {
            const div = document.createElement('div');
            div.className = `entry ${entry.completed ? 'completed' : ''}`;
            div.draggable = !isArchived;
            div.dataset.id = entry.id;

            if (!isArchived) {
                const handle = document.createElement('div');
                handle.className = 'drag-handle';
                handle.innerHTML = '<span></span><span></span><span></span>';
                div.appendChild(handle);
            }

            const checkbox = document.createElement('div');
            checkbox.className = `checkbox ${entry.completed ? 'checked' : ''}`;
            if (!isArchived) checkbox.onclick = () => toggleComplete(entry.id, day);
            div.appendChild(checkbox);

            const textWrap = document.createElement('div');
            textWrap.style.flex = '1';

            const textEl = document.createElement('div');
            textEl.className = 'entry-text';
            textEl.textContent = entry.text;
            textWrap.appendChild(textEl);

            const ts = document.createElement('div');
            ts.className = 'timestamp';
            ts.textContent = `created ${formatTimestamp(entry.createdAt)}` +
                (entry.completedAt ? ` Â· done ${formatTimestamp(entry.completedAt)}` : '');
            textWrap.appendChild(ts);

            if (isArchived && entry.day) {
                const tag = document.createElement('div');
                tag.className = 'archive-entry-tag';
                tag.textContent = `from ${entry.day}`;
                textWrap.appendChild(tag);
            }

            div.appendChild(textWrap);

            const actions = document.createElement('div');
            actions.className = 'entry-actions';

            if (!isArchived) {
                const swap = document.createElement('button');
                swap.className = 'btn';
                swap.textContent = day === 'today' ? 'â†’' : 'â†';
                swap.onclick = () => swapEntry(entry.id, day);
                actions.appendChild(swap);
            }

            const del = document.createElement('button');
            del.className = 'btn danger';
            del.textContent = 'Ã—';
            del.onclick = () => isArchived ? deleteArchivedEntry(entry.id) : deleteEntry(entry.id, day);
            actions.appendChild(del);

            div.appendChild(actions);

            if (!isArchived) {
                div.addEventListener('dragstart', e => { draggedEl = div; draggedId = entry.id; draggedDay = day; div.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
                div.addEventListener('dragend', () => div.classList.remove('dragging'));
                div.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect='move'; });
                div.addEventListener('drop', e => {
                    e.stopPropagation();
                    if (draggedEl !== div && draggedDay === day) {
                        const fi = data[day].findIndex(x => x.id === draggedId);
                        const ti = data[day].findIndex(x => x.id === entry.id);
                        if (fi !== -1 && ti !== -1) {
                            const [item] = data[day].splice(fi, 1);
                            data[day].splice(ti, 0, item);
                            saveData(); render();
                        }
                    }
                });
            }

            return div;
        }

        function render() {
            ['today','tomorrow'].forEach(day => {
                const c = document.getElementById(`${day}-entries`);
                c.innerHTML = '';
                data[day].forEach(e => c.appendChild(createEntryElement(e, day)));
                updateProgress(day);
            });
        }

        function updateProgress(day) {
            const total = data[day].length;
            const done = data[day].filter(e => e.completed).length;
            document.getElementById(`${day}-progress`).style.width = total > 0 ? `${(done/total)*100}%` : '0%';
            document.getElementById(`${day}-progress-text`).textContent = `${done} of ${total} completed`;
        }

        function addEntry(day) {
            const input = document.getElementById(`${day}-input`);
            const text = input.value.trim();
            if (!text) return;
            data[day].push({ id: Date.now(), text, completed: false, createdAt: Date.now(), completedAt: null });
            input.value = '';
            saveData(); render();
        }

        function toggleComplete(id, day) {
            const e = data[day].find(x => x.id === id);
            if (e) { e.completed = !e.completed; e.completedAt = e.completed ? Date.now() : null; saveData(); render(); }
        }

        function swapEntry(id, fromDay) {
            const toDay = fromDay === 'today' ? 'tomorrow' : 'today';
            const i = data[fromDay].findIndex(x => x.id === id);
            if (i !== -1) { data[toDay].push(data[fromDay].splice(i,1)[0]); saveData(); render(); }
        }

        function deleteEntry(id, day) {
            data[day] = data[day].filter(x => x.id !== id);
            saveData(); render();
        }

        function archiveAllCompleted() {
            ['today','tomorrow'].forEach(day => {
                const done = data[day].filter(e => e.completed).map(e => ({...e, day}));
                data.archived.unshift(...done);
                data[day] = data[day].filter(e => !e.completed);
            });
            saveData(); render();
        }

        function showArchive() {
            const container = document.getElementById('archive-entries');
            container.innerHTML = '';
            if (data.archived.length === 0) {
                const msg = document.createElement('div');
                msg.style.cssText = 'text-align:center;padding:40px 20px;color:var(--md-sys-color-outline)';
                msg.textContent = 'nothing archived yet';
                container.appendChild(msg);
            } else {
                data.archived.forEach(e => container.appendChild(createEntryElement(e, e.day, true)));
            }
            document.getElementById('archive-sheet').classList.add('active');
        }

        function deleteArchivedEntry(id) {
            data.archived = data.archived.filter(e => e.id !== id);
            saveData(); showArchive();
        }

        let draggedEl=null, draggedId=null, draggedDay=null;

        // â”€â”€ Color theming â”€â”€
        function hexToRgb(hex) {
            return [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
        }

        function toHex(r,g,b) {
            return '#' + [r,g,b].map(v => Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0')).join('');
        }

        function applyPrimaryColor(hex) {
            const [r,g,b] = hexToRgb(hex);
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const root = document.documentElement;
            if (isDark) {
                // Lighten for dark mode
                const lr = 255-(255-r)*0.3, lg = 255-(255-g)*0.3, lb = 255-(255-b)*0.3;
                root.style.setProperty('--md-sys-color-primary', toHex(lr,lg,lb));
                root.style.setProperty('--md-sys-color-on-primary', toHex(r*0.2,g*0.2,b*0.2));
                root.style.setProperty('--md-sys-color-primary-container', toHex(r*0.3,g*0.3,b*0.3));
                root.style.setProperty('--md-sys-color-on-primary-container', toHex(lr,lg,lb));
            } else {
                root.style.setProperty('--md-sys-color-primary', hex);
                root.style.setProperty('--md-sys-color-on-primary', '#ffffff');
                const cr = 255-(255-r)*0.18, cg = 255-(255-g)*0.18, cb = 255-(255-b)*0.18;
                root.style.setProperty('--md-sys-color-primary-container', toHex(cr,cg,cb));
                root.style.setProperty('--md-sys-color-on-primary-container', toHex(r*0.15,g*0.15,b*0.15));
            }
            document.getElementById('primary-swatch').style.background = hex;
            localStorage.setItem('icw-primary', hex);
        }

        function applySurfaceColor(hex) {
            const [r,g,b] = hexToRgb(hex);
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const root = document.documentElement;
            if (isDark) {
                // In dark mode, use a very dark version of the surface color
                root.style.setProperty('--md-sys-color-surface', toHex(r*0.08,g*0.08,b*0.08));
                root.style.setProperty('--md-sys-color-surface-container', toHex(r*0.13,g*0.13,b*0.13));
                root.style.setProperty('--md-sys-color-surface-container-high', toHex(r*0.16,g*0.16,b*0.16));
                root.style.setProperty('--md-sys-color-surface-container-highest', toHex(r*0.2,g*0.2,b*0.2));
            } else {
                root.style.setProperty('--md-sys-color-surface', hex);
                // Slightly darker variants
                root.style.setProperty('--md-sys-color-surface-container', toHex(r*0.97,g*0.97,b*0.97));
                root.style.setProperty('--md-sys-color-surface-container-high', toHex(r*0.94,g*0.94,b*0.94));
                root.style.setProperty('--md-sys-color-surface-container-highest', toHex(r*0.91,g*0.91,b*0.91));
            }
            document.getElementById('surface-swatch').style.background = hex;
            localStorage.setItem('icw-surface', hex);
        }

        // â”€â”€ Init â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            // Theme
            const savedTheme = localStorage.getItem('fold-notes-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-toggle').textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';

            // Colors
            const savedPrimary = localStorage.getItem('icw-primary');
            const savedSurface = localStorage.getItem('icw-surface');
            if (savedPrimary) { applyPrimaryColor(savedPrimary); document.getElementById('primary-color-picker').value = savedPrimary; }
            if (savedSurface) { applySurfaceColor(savedSurface); document.getElementById('surface-color-picker').value = savedSurface; }

            loadData(); updateDates(); render();

            // Forms
            document.getElementById('today-form').addEventListener('submit', e => { e.preventDefault(); addEntry('today'); });
            document.getElementById('tomorrow-form').addEventListener('submit', e => { e.preventDefault(); addEntry('tomorrow'); });

            // FAB
            const fabMain = document.getElementById('fab-main');
            const fabDial = document.getElementById('fab-speed-dial');
            const fabBackdrop = document.getElementById('fab-backdrop');

            function openFab() {
                fabDial.classList.add('open');
                fabMain.classList.add('open');
                fabMain.textContent = 'Ã—';
                fabBackdrop.style.display = 'block';
            }

            function closeFab() {
                fabDial.classList.remove('open');
                fabMain.classList.remove('open');
                fabMain.textContent = 'ï¼‹';
                fabBackdrop.style.display = 'none';
            }

            fabMain.addEventListener('click', () => fabDial.classList.contains('open') ? closeFab() : openFab());
            fabBackdrop.addEventListener('click', closeFab);

            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const cur = document.documentElement.getAttribute('data-theme');
                const next = cur === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('fold-notes-theme', next);
                document.getElementById('theme-toggle').textContent = next === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
                // Re-apply colors to adjust for new theme
                const p = localStorage.getItem('icw-primary');
                const s = localStorage.getItem('icw-surface');
                if (p) applyPrimaryColor(p);
                if (s) applySurfaceColor(s);
                closeFab();
            });

            // Primary color picker
            document.getElementById('primary-color-picker').addEventListener('input', e => applyPrimaryColor(e.target.value));

            // Surface color picker
            document.getElementById('surface-color-picker').addEventListener('input', e => applySurfaceColor(e.target.value));

            // Clear completed
            document.getElementById('fab-clear').addEventListener('click', () => { archiveAllCompleted(); closeFab(); });

            // Archive
            document.getElementById('fab-archive').addEventListener('click', () => { closeFab(); showArchive(); });

            // Close archive sheet
            document.getElementById('close-archive').addEventListener('click', () => document.getElementById('archive-sheet').classList.remove('active'));
            document.getElementById('archive-sheet').addEventListener('click', e => { if (e.target.id === 'archive-sheet') document.getElementById('archive-sheet').classList.remove('active'); });

            // Midnight date refresh
            setInterval(() => { const n = new Date(); if (n.getHours()===0&&n.getMinutes()===0) updateDates(); }, 60000);
        });

        // Service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/it-can-wait/sw.js', { scope: '/it-can-wait/' });
        }
    </script>
</body>
</html>
